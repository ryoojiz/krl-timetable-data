name: Test API Connection via Tor

on:
  workflow_dispatch:  # Allows manual trigger
  push:  # Runs on every push

jobs:
  test-api-tor:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt update
          sudo apt install -y tor python3-pip
          pip install requests[socks] stem

      - name: Start Tor Service
        run: |
          tor &  # Start Tor in the background
          sleep 10  # Give Tor time to start

      - name: Run API Test via Tor
        run: |
          import requests

          # API Endpoints
          APIS = {
              "STATION_API": "https://api-partner.krl.co.id/krl-webs/v1/krl-station",
              "SCHEDULE_API": "https://api-partner.krl.co.id/krl-webs/v1/schedule",
              "TRAIN_SCHEDULE_API": "https://api-partner.krl.co.id/krl-webs/v1/schedule-train"
          }

          # Authorization Token (Stored in GitHub Secrets)
          AUTH_TOKEN = "Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiJ9.eyJhdWQiOiIzIiwianRpIjoiMDYzNWIyOGMzYzg3YTY3ZTRjYWE4YTI0MjYxZGYwYzIxNjYzODA4NWM2NWU4ZjhiYzQ4OGNlM2JiZThmYWNmODU4YzY0YmI0MjgyM2EwOTUiLCJpYXQiOjE3MjI2MTc1MTQsIm5iZiI6MTcyMjYxNzUxNCwiZXhwIjoxNzU0MTUzNTE0LCJzdWIiOiI1Iiwic2NvcGVzIjpbXX0.Jz_sedcMtaZJ4dj0eWVc4_pr_wUQ3s1-UgpopFGhEmJt_iGzj6BdnOEEhcDDdIz-gydQL5ek0S_36v5h6P_X3OQyII3JmHp1SEDJMwrcy4FCY63-jGnhPBb4sprqUFruDRFSEIs1cNQ-3rv3qRDzJtGYc_bAkl2MfgZj85bvt2DDwBWPraZuCCkwz2fJvox-6qz6P7iK9YdQq8AjJfuNdl7t_1hMHixmtDG0KooVnfBV7PoChxvcWvs8FOmtYRdqD7RSEIoOXym2kcwqK-rmbWf9VuPQCN5gjLPimL4t2TbifBg5RWNIAAuHLcYzea48i3okbhkqGGlYTk3iVMU6Hf_Jruns1WJr3A961bd4rny62lNXyGPgNLRJJKedCs5lmtUTr4gZRec4Pz_MqDzlEYC3QzRAOZv0Ergp8-W1Vrv5gYyYNr-YQNdZ01mc7JH72N2dpU9G00K5kYxlcXDNVh8520-R-MrxYbmiFGVlNF2BzEH8qq6Ko9m0jT0NiKEOjetwegrbNdNq_oN4KmHvw2sHkGWY06rUeciYJMhBF1JZuRjj3JTwBUBVXcYZMFtwUAoikVByzKuaZZeTo1AtCiSjejSHNdpLxyKk_SFUzog5MOkUN1ktAhFnBFoz6SlWAJBJIS-lHYsdFLSug2YNiaNllkOUsDbYkiDtmPc9XWc"

          HEADERS = {
              "User-Agent": "Mozilla/5.0",
              "Accept": "application/json",
              "Authorization": AUTH_TOKEN
          }

          PROXIES = {
              "http": "socks5h://127.0.0.1:9050",
              "https": "socks5h://127.0.0.1:9050"
          }

          def test_api(endpoint_name, url):
              print(f"üîÑ Testing {endpoint_name} via Tor...")
              try:
                  response = requests.get(url, headers=HEADERS, proxies=PROXIES, timeout=30)
                  if response.status_code == 200:
                      print(f"‚úÖ {endpoint_name}: SUCCESS (Status {response.status_code})")
                  else:
                      print(f"‚ö†Ô∏è {endpoint_name}: ERROR (Status {response.status_code})")
              except requests.RequestException as e:
                  print(f"‚ùå {endpoint_name}: FAILED ‚Üí {e}")

          if __name__ == "__main__":
              for name, url in APIS.items():
                  test_api(name, url)
        shell: python
